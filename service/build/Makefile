# ========================
# Studio Service Makefile
# ========================

# é¡¹ç›®é…ç½®
PROJECT_NAME := studio-service
MODULE_NAME := studio/service
BINARY_NAME := api
BINARY_DIR := bin
BUILD_DIR := build
CMD_DIR := ./

# Go é…ç½®
GO := go
GOOS := $(shell go env GOOS)
GOARCH := $(shell go env GOARCH)
CGO_ENABLED := 0

# ç‰ˆæœ¬ä¿¡æ¯
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S')
GIT_COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# æ„å»ºæ ‡å¿—
LDFLAGS := -ldflags="-s -w -X main.Version=$(VERSION) -X main.BuildTime=$(BUILD_TIME) -X main.GitCommit=$(GIT_COMMIT)"

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# ===== å¸®åŠ©ä¿¡æ¯ =====
.PHONY: help
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Studio Service Makefile"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# ===== å¼€å‘ç›¸å…³ =====
.PHONY: init
init: ## åˆå§‹åŒ–é¡¹ç›®ä¾èµ–
	@echo "ğŸ”§ åˆå§‹åŒ–é¡¹ç›®..."
	$(GO) mod download
	$(GO) mod tidy
	@echo "âœ… é¡¹ç›®åˆå§‹åŒ–å®Œæˆ"

.PHONY: dev
dev: ## å¼€å‘æ¨¡å¼å¯åŠ¨ (çƒ­é‡è½½)
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	@if ! command -v air > /dev/null 2>&1; then \
		echo "ğŸ“¦ å®‰è£… air (çƒ­é‡è½½å·¥å…·)..."; \
		$(GO) install github.com/air-verse/air@v1.62.0; \
		echo "âœ… air å®‰è£…å®Œæˆ"; \
	else \
		echo "âœ… air å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…"; \
	fi
	air -c .air.web.toml

.PHONY: dev-schedule
dev-schedule: ## å¼€å‘æ¨¡å¼å¯åŠ¨ schedule (çƒ­é‡è½½)
	@echo "ğŸš€ å¯åŠ¨ schedule å¼€å‘æœåŠ¡å™¨..."
	@if ! command -v air > /dev/null 2>&1; then \
		echo "ğŸ“¦ å®‰è£… air (çƒ­é‡è½½å·¥å…·)..."; \
		$(GO) install github.com/air-verse/air@v1.62.0; \
		echo "âœ… air å®‰è£…å®Œæˆ"; \
	else \
		echo "âœ… air å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…"; \
	fi
	air -c .air.schedule.toml

.PHONY: run
run: build ## æ„å»ºå¹¶è¿è¡Œåº”ç”¨
	@echo "ğŸš€ å¯åŠ¨åº”ç”¨..."
	./$(BINARY_DIR)/$(BINARY_NAME)

.PHONY: start
start: ## å¿«é€Ÿå¯åŠ¨ (å¼€å‘æ¨¡å¼)
	@echo "âš¡ å¿«é€Ÿå¯åŠ¨..."
	$(GO) run ./$(CMD_DIR)

# ===== æ„å»ºç›¸å…³ =====
.PHONY: build
build: clean ## æ„å»ºåº”ç”¨
	@echo "ğŸ”¨ æ„å»ºåº”ç”¨..."
	@mkdir -p $(BINARY_DIR)
	CGO_ENABLED=$(CGO_ENABLED) GOOS=$(GOOS) GOARCH=$(GOARCH) \
	$(GO) build $(LDFLAGS) -o $(BINARY_DIR)/$(BINARY_NAME) ./$(CMD_DIR)
	@echo "âœ… æ„å»ºå®Œæˆ: $(BINARY_DIR)/$(BINARY_NAME)"

.PHONY: build-linux
build-linux: clean ## æ„å»º Linux ç‰ˆæœ¬
	@echo "ğŸ”¨ æ„å»º Linux ç‰ˆæœ¬..."
	@mkdir -p $(BINARY_DIR)
	CGO_ENABLED=$(CGO_ENABLED) GOOS=linux GOARCH=amd64 \
	$(GO) build $(LDFLAGS) -o $(BINARY_DIR)/$(BINARY_NAME)-linux ./$(CMD_DIR)
	@echo "âœ… Linux æ„å»ºå®Œæˆ: $(BINARY_DIR)/$(BINARY_NAME)-linux"

.PHONY: build-all
build-all: clean ## æ„å»ºæ‰€æœ‰å¹³å°ç‰ˆæœ¬
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰å¹³å°ç‰ˆæœ¬..."
	@mkdir -p $(BINARY_DIR)
	# Linux
	CGO_ENABLED=$(CGO_ENABLED) GOOS=linux GOARCH=amd64 \
	$(GO) build $(LDFLAGS) -o $(BINARY_DIR)/$(BINARY_NAME)-linux-amd64 ./$(CMD_DIR)
	# macOS
	CGO_ENABLED=$(CGO_ENABLED) GOOS=darwin GOARCH=amd64 \
	$(GO) build $(LDFLAGS) -o $(BINARY_DIR)/$(BINARY_NAME)-darwin-amd64 ./$(CMD_DIR)
	CGO_ENABLED=$(CGO_ENABLED) GOOS=darwin GOARCH=arm64 \
	$(GO) build $(LDFLAGS) -o $(BINARY_DIR)/$(BINARY_NAME)-darwin-arm64 ./$(CMD_DIR)
	# Windows
	CGO_ENABLED=$(CGO_ENABLED) GOOS=windows GOARCH=amd64 \
	$(GO) build $(LDFLAGS) -o $(BINARY_DIR)/$(BINARY_NAME)-windows-amd64.exe ./$(CMD_DIR)
	@echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ"

# ===== æµ‹è¯•ç›¸å…³ =====
.PHONY: test
test: ## è¿è¡Œæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	$(GO) test -v ./...

.PHONY: test-coverage
test-coverage: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•è¦†ç›–ç‡..."
	$(GO) test -v -coverprofile=coverage.out ./...
	$(GO) tool cover -html=coverage.out -o coverage.html
	@echo "ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Š: coverage.html"

.PHONY: bench
bench: ## è¿è¡ŒåŸºå‡†æµ‹è¯•
	@echo "âš¡ è¿è¡ŒåŸºå‡†æµ‹è¯•..."
	$(GO) test -bench=. -benchmem ./...

# ===== ä»£ç è´¨é‡ =====
.PHONY: fmt
fmt: ## æ ¼å¼åŒ–ä»£ç 
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	$(GO) fmt ./...
	@if command -v goimports > /dev/null; then \
		goimports -w .; \
	fi

.PHONY: lint
lint: ## ä»£ç æ£€æŸ¥
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	@if ! command -v golangci-lint > /dev/null; then \
		echo "ğŸ“¦ å®‰è£… golangci-lint..."; \
		curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $$(go env GOPATH)/bin v1.54.2; \
	fi
	golangci-lint run

.PHONY: vet
vet: ## Go vet æ£€æŸ¥
	@echo "ğŸ” Go vet æ£€æŸ¥..."
	$(GO) vet ./...

.PHONY: mod
mod: ## æ•´ç†ä¾èµ–
	@echo "ğŸ“¦ æ•´ç†ä¾èµ–..."
	$(GO) mod tidy
	$(GO) mod verify

# ===== Docker ç›¸å…³ =====
.PHONY: docker-build
docker-build: ## æ„å»º Docker é•œåƒ
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build -f $(BUILD_DIR)/Dockerfile -t $(PROJECT_NAME):$(VERSION) .
	docker tag $(PROJECT_NAME):$(VERSION) $(PROJECT_NAME):latest

.PHONY: docker-run
docker-run: ## è¿è¡Œ Docker å®¹å™¨
	@echo "ğŸ³ è¿è¡Œ Docker å®¹å™¨..."
	docker run -p 8080:8080 --name $(PROJECT_NAME) $(PROJECT_NAME):latest

.PHONY: docker-stop
docker-stop: ## åœæ­¢ Docker å®¹å™¨
	@echo "ğŸ›‘ åœæ­¢ Docker å®¹å™¨..."
	docker stop $(PROJECT_NAME) || true
	docker rm $(PROJECT_NAME) || true

# ===== æ¸…ç†ç›¸å…³ =====
.PHONY: clean
clean: ## æ¸…ç†æ„å»ºæ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(BINARY_DIR)
	@rm -f coverage.out coverage.html
	@echo "âœ… æ¸…ç†å®Œæˆ"

.PHONY: clean-all
clean-all: clean ## æ·±åº¦æ¸…ç† (åŒ…æ‹¬ Docker)
	@echo "ğŸ§¹ æ·±åº¦æ¸…ç†..."
	@docker rmi $(PROJECT_NAME):$(VERSION) $(PROJECT_NAME):latest 2>/dev/null || true
	$(GO) clean -cache -modcache -testcache
	@echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"

# ===== éƒ¨ç½²ç›¸å…³ =====
.PHONY: install
install: build ## å®‰è£…åˆ°ç³»ç»Ÿ
	@echo "ğŸ“¦ å®‰è£…åº”ç”¨..."
	@install -d $(DESTDIR)/usr/local/bin
	@install -m 755 $(BINARY_DIR)/$(BINARY_NAME) $(DESTDIR)/usr/local/bin/
	@echo "âœ… å®‰è£…å®Œæˆ"

# ===== ä¿¡æ¯æŸ¥çœ‹ =====
.PHONY: info
info: ## æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
	@echo "é¡¹ç›®ä¿¡æ¯:"
	@echo "  é¡¹ç›®åç§°: $(PROJECT_NAME)"
	@echo "  æ¨¡å—åç§°: $(MODULE_NAME)"
	@echo "  ç‰ˆæœ¬: $(VERSION)"
	@echo "  æ„å»ºæ—¶é—´: $(BUILD_TIME)"
	@echo "  Git æäº¤: $(GIT_COMMIT)"
	@echo "  Go ç‰ˆæœ¬: $$($(GO) version)"
	@echo "  ç³»ç»Ÿ: $(GOOS)/$(GOARCH)"

# ç¡®ä¿è¿™äº›ç›®æ ‡ä¸è¢«è¯¯è®¤ä¸ºæ˜¯æ–‡ä»¶
.PHONY: all build clean test generate apiserver migrate lint fmt-install fmt build-web stringer-install


stringer-install:
	@if ! command -v stringer > /dev/null; then \
		echo "ğŸ“¦ å®‰è£… stringer..."; \
		go install golang.org/x/tools/cmd/stringer@latest; \
	fi
# ç”Ÿæˆé”™è¯¯ç 
generate: stringer-install
	go generate ./pkg/...

# è¿è¡Œ migrate
migrate:
	go run main.go migrate

# è¿è¡ŒæœåŠ¡
apiserver: generate
	go run main.go apiserver

# è¿è¡Œè°ƒåº¦
schedule: generate
	go run main.go schedule


fmt-install:
	go install mvdan.cc/gofumpt@v0.8.0

fmt-go: fmt-install
	gofumpt -l -w ./pkg ./cmd ./internal
	go fmt ./pkg/... ./cmd/... ./internal/...
	goimports -w ./pkg ./cmd ./internal


lint-install-go:
	go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.3.0

lint-go: fmt-go lint-install-go
	golangci-lint run -v --max-same-issues=0 --timeout=5m --tests=false -c .golangci.yaml  ./...


build-web: fmt
	go build -o ./bin/web main.go
